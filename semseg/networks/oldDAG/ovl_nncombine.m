%function [ Y, dzdw ] = vl_nncombine(X1, X2, W, dzdy)
%	if(nargin == 3)
%		% X2 = 2 --> X1 = 7
%		% X2 = 3 --> X1 = 8
%		% X2 = 4 --> X1 = 9
%		% X2 = 5 --> X1 = 10
%		% X2 = 6 --> X1 = 11
%		Y = gpuArray.zeros(size(X1), 'single');
%		Y(:,:,1, :) = W(1) .* X1(:,:,1,:) + (1-W(1)) .* X2(:,:,1,:);
%		Y(:,:,2, :) = W(2) .* X1(:,:,2,:) + (1-W(2)) .* X2(:,:,1,:);
%		Y(:,:,3, :) = W(3) .* X1(:,:,3,:) + (1-W(3)) .* X2(:,:,1,:);
%		Y(:,:,4, :) = W(4) .* X1(:,:,4,:) + (1-W(4)) .* X2(:,:,1,:);
%		Y(:,:,5, :) = W(5) .* X1(:,:,5,:) + (1-W(5)) .* X2(:,:,1,:);
%		Y(:,:,6, :) = W(6) .* X1(:,:,6,:) + (1-W(6)) .* X2(:,:,1,:);
%		Y(:,:,7, :) = W(7) .* X1(:,:,7,:) + (1-W(7)) .* X2(:,:,2,:);
%		Y(:,:,8, :) = W(8) .* X1(:,:,8,:) + (1-W(8)) .* X2(:,:,3,:);
%		Y(:,:,9, :) = W(9) .* X1(:,:,9,:) + (1-W(9)) .* X2(:,:,4,:);
%		Y(:,:,10, :) = W(10) .* X1(:,:,10,:) + (1-W(10)) .* X2(:,:,5,:);
%		Y(:,:,11, :) = W(11) .* X1(:,:,11,:) + (1-W(11)) .* X2(:,:,6,:);
%	else
%		Y = cell(1, 2);
%		Y{1} = gpuArray.zeros(size(X1), 'single');
%		Y{2} = gpuArray.zeros(size(X2), 'single');

%		dzdw = gpuArray.zeros(size(W), 'single');
%		dzdw(1) = sum(sum(sum((X1(:,:,1,:) - X2(:,:,1,:)) .* dzdy(:,:,1,:))));
%		dzdw(2) = sum(sum(sum((X1(:,:,2,:) - X2(:,:,1,:)) .* dzdy(:,:,2,:))));
%		dzdw(3) = sum(sum(sum((X1(:,:,3,:) - X2(:,:,1,:)) .* dzdy(:,:,3,:))));
%		dzdw(4) = sum(sum(sum((X1(:,:,4,:) - X2(:,:,1,:)) .* dzdy(:,:,4,:))));
%		dzdw(5) = sum(sum(sum((X1(:,:,5,:) - X2(:,:,1,:)) .* dzdy(:,:,5,:))));
%		dzdw(6) = sum(sum(sum((X1(:,:,6,:) - X2(:,:,1,:)) .* dzdy(:,:,6,:))));
%		dzdw(7) = sum(sum(sum((X1(:,:,7,:) - X2(:,:,2,:)) .* dzdy(:,:,7,:))));
%		dzdw(8) = sum(sum(sum((X1(:,:,8,:) - X2(:,:,3,:)) .* dzdy(:,:,8,:))));
%		dzdw(9) = sum(sum(sum((X1(:,:,9,:) - X2(:,:,4,:)) .* dzdy(:,:,9,:))));
%		dzdw(10) = sum(sum(sum((X1(:,:,10,:) - X2(:,:,5,:)) .* dzdy(:,:,10,:))));
%		dzdw(11) = sum(sum(sum((X1(:,:,11,:) - X2(:,:,6,:)) .* dzdy(:,:,11,:))));
%	end
%end

function [ Y, dzdw ] = vl_nncombine(X1, X2, W, dzdy)
	if(nargin == 3)
%		% X2 = 2 --> X1 = 7
%		% X2 = 3 --> X1 = 8
%		% X2 = 4 --> X1 = 9
%		% X2 = 5 --> X1 = 10
%		% X2 = 6 --> X1 = 11
		Y = gpuArray.zeros(size(X1), 'single');
		Y(:,:,1, :) = X1(:,:,1,:) + W(1) .* X2(:,:,1,:);
		Y(:,:,2, :) = X1(:,:,2,:) + W(2) .* X2(:,:,1,:);
		Y(:,:,3, :) = X1(:,:,3,:) + W(3) .* X2(:,:,1,:);
		Y(:,:,4, :) = X1(:,:,4,:) + W(4) .* X2(:,:,1,:);
		Y(:,:,5, :) = X1(:,:,5,:) + W(5) .* X2(:,:,1,:);
		Y(:,:,6, :) = X1(:,:,6,:) + W(6) .* X2(:,:,1,:);
		Y(:,:,7, :) = X1(:,:,7,:) + W(7) .* X2(:,:,2,:);
		Y(:,:,8, :) = X1(:,:,8,:) + W(8) .* X2(:,:,3,:);
		Y(:,:,9, :) = X1(:,:,9,:) + W(9) .* X2(:,:,4,:);
		Y(:,:,10, :) =X1(:,:,10,:) + W(10) .* X2(:,:,5,:);
		Y(:,:,11, :) = X1(:,:,11,:) + W(11) .* X2(:,:,6,:);
	else
		Y = cell(1, 2);
		Y{1} = gpuArray.zeros(size(X1), 'single');
		Y{2} = gpuArray.zeros(size(X2), 'single');

		dzdw = gpuArray.zeros(size(W), 'single');
		dzdw(1) = sum(sum(sum((X2(:,:,1,:)) .* dzdy(:,:,1,:))));
		dzdw(2) = sum(sum(sum((X2(:,:,1,:)) .* dzdy(:,:,2,:))));
		dzdw(3) = sum(sum(sum((X2(:,:,1,:)) .* dzdy(:,:,3,:))));
		dzdw(4) = sum(sum(sum((X2(:,:,1,:)) .* dzdy(:,:,4,:))));
		dzdw(5) = sum(sum(sum((X2(:,:,1,:)) .* dzdy(:,:,5,:))));
		dzdw(6) = sum(sum(sum((X2(:,:,1,:)) .* dzdy(:,:,6,:))));
		dzdw(7) = sum(sum(sum((X2(:,:,2,:)) .* dzdy(:,:,7,:))));
		dzdw(8) = sum(sum(sum((X2(:,:,3,:)) .* dzdy(:,:,8,:))));
		dzdw(9) = sum(sum(sum((X2(:,:,4,:)) .* dzdy(:,:,9,:))));
		dzdw(10) = sum(sum(sum((X2(:,:,5,:)) .* dzdy(:,:,10,:))));
		dzdw(11) = sum(sum(sum((X2(:,:,6,:)) .* dzdy(:,:,11,:))));
	end
%end


